# ==============================================================================
#  Configuración de Nginx como Proxy Inverso para el Sistema MECSOL AI
# ==============================================================================
#
# Rol: Punto de entrada único para todo el tráfico HTTP.
# Función: Enruta las solicitudes al microservicio o frontend correspondiente
# basándose en el prefijo de la URL.
#
# Arquitectura de Enrutamiento:
#   - /api/finance/...   -> Agente de Finanzas (Servicio: finance_agent, Puerto: 5001)
#   - /api/operations/...-> Agente de Operaciones (Servicio: operations_agent, Puerto: 5002)
#   - /api/commercial/...-> Agente Comercial (Servicio: commercial_agent, Puerto: 5003)
#   - / (cualquier otra) -> Frontend (Servicio: frontend, Puerto: 80)
#
# ==============================================================================

server {
    # Escucha en el puerto 80 estándar para el tráfico HTTP.
    listen 80;

    # Nombre del servidor. Usar '_' como un comodín para aceptar cualquier nombre de host.
    server_name _;

    # Configuración de logs para monitoreo y depuración.
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # --- ENRUTAMIENTO DE APIS DE MICROSERVICIOS ---

    # 1. Agente de Finanzas
    location /api/finance/ {
        proxy_pass http://finance_agent:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 2. Agente de Operaciones
    location /api/operations/ {
        proxy_pass http://operations_agent:5002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 3. Agente Comercial
    location /api/commercial/ {
        proxy_pass http://commercial_agent:5003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- ENRUTAMIENTO DEL FRONTEND (COMODÍN) ---

    # 4. Aplicación Frontend
    location / {
        proxy_pass http://frontend:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
