# ==============================================================================
#  Configuración de Nginx como Proxy Inverso para el Sistema MECSOL AI
# ==============================================================================
#
# Rol: Punto de entrada único para todo el tráfico HTTP.
# Función: Enruta las solicitudes al microservicio o frontend correspondiente
# basándose en el prefijo de la URL.
#
# Arquitectura de Enrutamiento:
#   - /api/finance/...   -> Agente de Finanzas (Servicio: finance_agent, Puerto: 5001)
#   - /api/operations/...-> Agente de Operaciones (Servicio: operations_agent, Puerto: 5002)
#   - /api/commercial/...-> Agente Comercial (Servicio: commercial_agent, Puerto: 5003)
#   - / (cualquier otra) -> Frontend (Servicio: frontend, Puerto: 80)
#
# ==============================================================================

server {
    listen 80;
    server_name _;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # --- ENRUTAMIENTO DE APIS DE MICROSERVICIOS ---

    location /api/finance/ {
        proxy_pass http://finance_agent:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/operations/ {
        proxy_pass http://operations_agent:5002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/commercial/ {
        proxy_pass http://commercial_agent:5003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- ENRUTAMIENTO DEL FRONTEND (COMODÍN) ---

    location / {
        proxy_pass http://frontend:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
